<!doctype html>
<html lang="zh-TW" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>桌號查詢系統</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap">

  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      font-family: 'Noto Sans TC', system-ui, -apple-system, sans-serif;
    }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #eid::placeholder { color: #6b7280; }
  </style>
</head>

<body class="h-full">
  <div id="app" class="w-full h-full"></div>

  <script>
    // ============================================================
    // ✅ Google Sheet（Publish to web → CSV）
    // ============================================================
    const PUBLISHED_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRHlG9WMRmD7yKNT3sOFSxmI4QWPI-kz8pGXKRoNxuVDMajS9RT4JWCT-s0sbcPDoBECq4tTGbVeNcd/pub?gid=1865948020&single=true&output=csv";

    // ============================================================
    // UI 設定
    // ============================================================
    const config = {
      background_color: '#0f172a',
      surface_color: '#1e293b',
      text_color: '#f1f5f9',
      primary_action_color: '#3b82f6',
      secondary_action_color: '#64748b',
      font_size: 16,
      app_title: '桌號查詢'
    };

    let allEmployeeData = [];
    let isLoading = true;
    let isReloading = false;
    let autoClearTimer = null;
    let msgTimer = null;
    let lastLoadedAt = null;

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }

    function csvUrl() {
      return PUBLISHED_CSV_URL + (PUBLISHED_CSV_URL.includes('?') ? '&' : '?') + `_=${Date.now()}`;
    }

    function parseCsvLine(line) {
      const out = [];
      let cur = '', inQ = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQ && line[i+1] === '"') { cur += '"'; i++; }
          else inQ = !inQ;
        } else if (ch === ',' && !inQ) {
          out.push(cur); cur = '';
        } else {
          cur += ch;
        }
      }
      out.push(cur);
      return out.map(s => s.trim());
    }

    function findHeaderIndex(headers, candidates) {
      const lower = headers.map(h => String(h || '').trim().toLowerCase());
      for (const cand of candidates) {
        const idx = lower.indexOf(String(cand).toLowerCase());
        if (idx >= 0) return idx;
      }
      return -1;
    }

    async function fetchSheetDataFromCsv() {
      const res = await fetch(csvUrl(), { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const csv = await res.text();
      const lines = csv.split(/\r?\n/).filter(l => l.trim());

      if (lines.length < 2) return [];

      const headers = parseCsvLine(lines[0]);
      const idxEmp = findHeaderIndex(headers, ['employee_id','employee id','員工編號','员工编号']);
      const idxDesk = findHeaderIndex(headers, ['desk_number','desk number','桌號','桌号']);

      const empCol = idxEmp >= 0 ? idxEmp : 0;
      const deskCol = idxDesk >= 0 ? idxDesk : 1;

      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = parseCsvLine(lines[i]);
        const employee_id = String(cols[empCol] ?? '').trim();
        const desk_number = String(cols[deskCol] ?? '').trim();
        if (employee_id && desk_number) data.push({ employee_id, desk_number });
      }

      const seen = new Set();
      const dedup = [];
      for (const r of data) {
        if (seen.has(r.employee_id)) continue;
        seen.add(r.employee_id);
        dedup.push(r);
        if (dedup.length >= 999) break;
      }
      return dedup;
    }

    async function loadInitial() {
      allEmployeeData = await fetchSheetDataFromCsv();
      lastLoadedAt = new Date();
      isLoading = false;
      render();
    }

    async function reloadData() {
      if (isLoading || isReloading) return;
      isReloading = true;
      render();
      try {
        allEmployeeData = await fetchSheetDataFromCsv();
        lastLoadedAt = new Date();
        showMessage(`已重新載入資料（${allEmployeeData.length} 筆）`, true);
      } catch (e) {
        showMessage('重新載入失敗，請稍後再試', false);
      } finally {
        isReloading = false;
        render();
      }
    }

    function showMessage(text, ok) {
      const el = document.getElementById('message');
      if (!el) return;
      if (msgTimer) clearTimeout(msgTimer);
      const color = ok ? '#10b981' : '#ef4444';
      el.innerHTML = `
        <div class="fade-in" style="margin-top:12px;padding:10px 12px;border-left:4px solid ${color};background:rgba(255,255,255,.06)">
          <div style="color:${color};font-weight:700">${ok?'完成':'提醒'}</div>
          <div>${escapeHtml(text)}</div>
        </div>`;
      msgTimer = setTimeout(() => el.innerHTML = '', ok ? 2000 : 4000);
    }

    function render() {
      const app = document.getElementById('app');
      const f = config.font_size;
      const last = lastLoadedAt ? lastLoadedAt.toLocaleString() : '尚未載入';

      app.innerHTML = `
        <div class="min-h-full flex items-center justify-center p-6" style="background:${config.background_color};color:${config.text_color}">
          <div class="w-full max-w-md">
            <div class="text-center mb-6">
              <h1 style="font-size:${f*2}px;font-weight:700">${config.app_title}</h1>
              <div style="font-size:${f*.85}px;opacity:.8">資料來源：Google Sheet（同步）</div>
              <div style="font-size:${f*.75}px;opacity:.65">最近載入：${last}</div>
            </div>

            <div class="p-6 rounded-lg" style="background:${config.surface_color}">
              <div style="display:flex;gap:${f}px;margin-bottom:${f}px">
                <button id="reloadBtn" style="flex:1;background:${config.secondary_action_color};color:#fff;padding:${f*.85}px;border-radius:8px;border:none">
                  ${isReloading?'載入中…':'重新載入資料'}
                </button>
                <div style="flex:1;text-align:right;font-size:${f*.85}px;opacity:.85">
                  目前資料筆數：${allEmployeeData.length}
                </div>
              </div>

              <input id="eid" type="text" inputmode="numeric" placeholder="請輸入員工編號"
                style="width:100%;padding:${f}px;border-radius:8px;border:none;margin-bottom:${f}px;font-size:${f*1.1}px;color:#000;background:#fff">

              <div style="display:flex;gap:${f}px">
                <button id="queryBtn" style="flex:1;background:${config.primary_action_color};color:#fff;padding:${f}px;border-radius:8px;border:none">查詢</button>
                <button id="resetBtn" style="flex:1;background:${config.secondary_action_color};color:#fff;padding:${f}px;border-radius:8px;border:none">重設</button>
              </div>

              <div id="result" style="margin-top:${f}px"></div>
              <div id="message"></div>
            </div>

            <div class="text-center" style="margin-top:${f}px;font-size:${f*.8}px;opacity:.7">
              管理者請直接編輯 Google Sheet
            </div>
          </div>
        </div>`;

      const input = document.getElementById('eid');
      document.getElementById('reloadBtn').onclick = reloadData;
      document.getElementById('queryBtn').onclick = query;
      document.getElementById('resetBtn').onclick = resetQ;

      input.oninput = e => {
        let v = e.target.value.replace(/\D/g,'');
        if (v.length > 7) v = v.slice(0,7);
        e.target.value = v;
      };
      input.onkeydown = e => { if (e.key === 'Enter') query(); };
    }

    function resetQ() {
      const input = document.getElementById('eid');
      if (input) input.value = '';
      document.getElementById('result').innerHTML = '';
      document.getElementById('message').innerHTML = '';
      input?.focus();
    }

    function query() {
      const id = document.getElementById('eid').value.trim();
      const res = document.getElementById('result');
      if (!id) return;

      const found = allEmployeeData.find(r => r.employee_id === id);
      res.innerHTML = found
        ? `<div class="fade-in" style="padding:12px;border-left:4px solid ${config.primary_action_color}">
             座位：<strong style="font-size:1.4em">${escapeHtml(found.desk_number)}</strong>
           </div>`
        : `<div class="fade-in" style="padding:12px;border-left:4px solid #ef4444">查無此員工</div>`;

      autoClearTimer = setTimeout(() => res.innerHTML = '', 3000);
    }

    render();
    loadInitial();
  </script>
</body>
</html>