<!doctype html>
<html lang="zh-TW" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>桌號查詢系統</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap">

  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      font-family: 'Noto Sans TC', system-ui, -apple-system, sans-serif;
    }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #eid::placeholder { color: #6b7280; }
  </style>
</head>

<body class="h-full">
  <div id="app" class="w-full h-full"></div>

  <script>
    // ============================================================
    // ✅ Google Sheet 設定（已幫你填好）
    // ============================================================
    const GOOGLE_SHEET_ID = "1GDtxQPMryH3_q998dz4p4oZA8kuz8And1RwwakbvjYA";
    const GOOGLE_SHEET_TAB_NAME = "總表"; // ✅ 你的分頁名稱

    // ============================================================
    // UI 設定
    // ============================================================
    const config = {
      background_color: '#0f172a',
      surface_color: '#1e293b',
      text_color: '#f1f5f9',
      primary_action_color: '#3b82f6',
      secondary_action_color: '#64748b',
      font_size: 16,
      app_title: '桌號查詢'
    };

    let allEmployeeData = [];
    let isLoading = true;       // 初次載入
    let isReloading = false;    // 手動重新載入
    let autoClearTimer = null;
    let msgTimer = null;
    let lastLoadedAt = null;

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }

    function sheetUrl() {
      let base = `https://docs.google.com/spreadsheets/d/${encodeURIComponent(GOOGLE_SHEET_ID)}/gviz/tq?tqx=out:json`;
      if (GOOGLE_SHEET_TAB_NAME && GOOGLE_SHEET_TAB_NAME.trim()) {
        base += `&sheet=${encodeURIComponent(GOOGLE_SHEET_TAB_NAME.trim())}`;
      }
      // cache bust，避免手機/中間層快取
      return base + `&_=${Date.now()}`;
    }

    function normalizeRow(cols, row) {
      const obj = {};
      (row.c || []).forEach((cell, i) => {
        obj[cols[i] || `col_${i}`] = (cell && cell.v != null) ? cell.v : '';
      });

      const employee_id = String(obj.employee_id || obj['Employee ID'] || obj['員工編號'] || obj['员工编号'] || '').trim();
      const desk_number = String(obj.desk_number || obj['Desk Number'] || obj['桌號'] || obj['桌号'] || '').trim();

      if (!employee_id || !desk_number) return null;
      return { employee_id, desk_number };
    }

    async function fetchSheetData() {
      const url = sheetUrl();
      const res = await fetch(url, { cache: 'no-store' });

      // 若不是 2xx，直接丟出更清楚的錯誤
      if (!res.ok) {
        throw new Error(`HTTP ${res.status} ${res.statusText}（無法讀取 Google Sheet）`);
      }

      const text = await res.text();

      // gviz 回傳不是純 JSON，要截取 {...}
      const start = text.indexOf('{');
      const end = text.lastIndexOf('}');
      if (start === -1 || end === -1) {
        throw new Error('回傳內容不是預期的 JSON（可能需要登入或權限不足）');
      }

      let json;
      try {
        json = JSON.parse(text.substring(start, end + 1));
      } catch (e) {
        throw new Error('JSON 解析失敗（可能是權限/回傳格式異常）');
      }

      const table = json.table || {};
      const cols = (table.cols || []).map(c => (c.label || '').trim());
      const rows = table.rows || [];

      const normalized = [];
      for (const r of rows) {
        const item = normalizeRow(cols, r);
        if (item) normalized.push(item);
      }

      // 去重：同 employee_id 保留第一筆
      const seen = new Set();
      let data = normalized.filter(x => {
        const key = String(x.employee_id);
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });

      // 限制最多 999
      if (data.length > 999) data = data.slice(0, 999);

      return data;
    }

    async function loadDataInitial() {
      allEmployeeData = await fetchSheetData();
      lastLoadedAt = new Date();
      isLoading = false;
      render();
    }

    async function reloadData() {
      if (isLoading || isReloading) return;

      isReloading = true;
      render(); // 先讓按鈕變成載入中
      try {
        allEmployeeData = await fetchSheetData();
        lastLoadedAt = new Date();
        showMessage(`已重新載入資料（${allEmployeeData.length} 筆）`, true);
      } catch (err) {
        console.error(err);
        // ✅ 重新載入失敗：顯示更具體錯誤
        showMessage(`重新載入失敗：${err?.message || String(err)}`, false);
      } finally {
        isReloading = false;
        render();
      }
    }

    function showMessage(text, isSuccess) {
      const el = document.getElementById('message');
      if (!el) return;

      if (msgTimer) clearTimeout(msgTimer);
      const color = isSuccess ? '#10b981' : '#ef4444';

      el.innerHTML = `
        <div class="fade-in" style="margin-top:12px; padding:10px 12px; border-left:4px solid ${color}; background:rgba(255,255,255,0.06);">
          <div style="color:${color}; font-weight:700; margin-bottom:4px;">
            ${isSuccess ? '完成' : '提醒'}
          </div>
          <div style="opacity:0.9;">${escapeHtml(text)}</div>
        </div>
      `;
      msgTimer = setTimeout(() => { el.innerHTML = ''; }, isSuccess ? 2000 : 4500);
    }

    function clearResult() {
      const res = document.getElementById('result');
      if (res) res.innerHTML = '';
      if (autoClearTimer) {
        clearTimeout(autoClearTimer);
        autoClearTimer = null;
      }
    }

    function render() {
      const app = document.getElementById('app');
      const f = config.font_size;

      const lastLoadedText = lastLoadedAt ? lastLoadedAt.toLocaleString() : '尚未載入';

      app.innerHTML = `
        <div class="min-h-full flex items-center justify-center p-6" style="background:${config.background_color};color:${config.text_color}">
          <div class="w-full max-w-md">
            <div class="text-center mb-6">
              <h1 style="font-size:${f*2}px;font-weight:700">${escapeHtml(config.app_title)}</h1>
              <div style="font-size:${f*0.85}px;opacity:.8">資料來源：Google Sheet（全裝置同步）</div>
              <div style="font-size:${f*0.78}px;opacity:.7;margin-top:6px">最近載入：${escapeHtml(lastLoadedText)}</div>
              <div style="font-size:${f*0.78}px;opacity:.65;margin-top:4px">分頁：${escapeHtml(GOOGLE_SHEET_TAB_NAME)}</div>
            </div>

            <div class="p-6 rounded-lg" style="background:${config.surface_color}">
              <div style="display:flex; gap:${f}px; align-items:center; margin-bottom:${f}px;">
                <button id="reloadBtn"
                  style="flex:1;background:${config.secondary_action_color};color:white;padding:${f*0.85}px;border-radius:8px;border:none;cursor:pointer">
                  ${isReloading ? '載入中… Loading…' : '重新載入資料 Reload'}
                </button>

                <div style="flex:1; font-size:${f*0.85}px; opacity:.85; text-align:right;">
                  目前資料筆數：${allEmployeeData.length}
                </div>
              </div>

              <input
                id="eid"
                type="text"
                inputmode="numeric"
                placeholder="請輸入員工編號"
                style="
                  width:100%;
                  padding:${f}px;
                  border-radius:8px;
                  border:none;
                  margin-bottom:${f}px;
                  font-size:${f*1.1}px;
                  color:#000000;
                  background-color:#ffffff;
                ">

              <div style="display:flex;gap:${f}px">
                <button id="queryBtn"
                  style="flex:1;background:${config.primary_action_color};color:white;padding:${f}px;border-radius:8px;border:none;cursor:pointer">
                  查詢
                </button>
                <button id="resetBtn"
                  style="flex:1;background:${config.secondary_action_color};color:white;padding:${f}px;border-radius:8px;border:none;cursor:pointer">
                  重設
                </button>
              </div>

              <div id="result" style="margin-top:${f}px"></div>
              <div id="message"></div>

              ${isLoading ? `<div class="fade-in" style="margin-top:${f}px;opacity:.75">資料載入中…</div>` : ``}
            </div>

            <div class="text-center" style="margin-top:${f}px;font-size:${f*0.8}px;opacity:.7">
              管理者請直接編輯 Google Sheet（改完可按「重新載入」同步）
            </div>

            <div class="text-center" style="margin-top:${f*0.75}px;font-size:${f*0.72}px;opacity:.55">
              Debug：如果讀取失敗，請直接在瀏覽器開啟此連結檢查是否需要登入：<br>
              <span style="word-break:break-all;">${escapeHtml(sheetUrl())}</span>
            </div>

          </div>
        </div>
      `;

      // 綁定事件（每次 render 都要重綁）
      const input = document.getElementById('eid');
      const queryBtn = document.getElementById('queryBtn');
      const resetBtn = document.getElementById('resetBtn');
      const reloadBtn = document.getElementById('reloadBtn');

      input.addEventListener('input', (e) => {
        let v = e.target.value.replace(/[^0-9]/g, '');
        if (v.length > 7) v = v.slice(0, 7);
        e.target.value = v;
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') query();
      });

      queryBtn.addEventListener('click', () => query());
      resetBtn.addEventListener('click', () => resetQ());
      reloadBtn.addEventListener('click', () => reloadData());
    }

    function resetQ() {
      const input = document.getElementById('eid');
      if (input) input.value = '';
      clearResult();
      if (msgTimer) {
        clearTimeout(msgTimer);
        msgTimer = null;
      }
      const msg = document.getElementById('message');
      if (msg) msg.innerHTML = '';
      input?.focus();
    }

    function query() {
      const input = document.getElementById('eid');
      const res = document.getElementById('result');
      if (!input || !res) return;

      const id = input.value.trim();
      if (!id) return;

      if (isLoading) {
        res.innerHTML = `<div class="fade-in" style="padding:12px;border-left:4px solid ${config.primary_action_color};opacity:.9">
          資料仍在載入中，請稍後再試
        </div>`;
        autoClearTimer = setTimeout(() => res.innerHTML = '', 2000);
        return;
      }

      clearTimeout(autoClearTimer);

      const found = allEmployeeData.find(r => r.employee_id === id);

      if (found) {
        res.innerHTML = `<div class="fade-in" style="padding:12px;border-left:4px solid ${config.primary_action_color}">
          座位：<strong style="font-size:1.4em">${escapeHtml(found.desk_number)}</strong>
        </div>`;
      } else {
        res.innerHTML = `<div class="fade-in" style="padding:12px;border-left:4px solid #ef4444">
          查無此員工
        </div>`;
      }

      autoClearTimer = setTimeout(() => res.innerHTML = '', 3000);
    }

    // init
    render();
    loadDataInitial().catch(err => {
      console.error(err);
      isLoading = false;
      render();

      // ✅ 保險修正版：把真正錯誤訊息顯示在畫面上
      const res = document.getElementById('result');
      if (res) {
        res.innerHTML = `<div class="fade-in" style="padding:12px;border-left:4px solid #ef4444">
          <div style="font-weight:700;margin-bottom:6px">讀取 Google Sheet 失敗</div>
          <div style="opacity:.9;margin-bottom:8px">
            可能原因：權限、分頁名稱、或網路阻擋（例如公司網路/CORS/隱私設定）
          </div>
          <div style="opacity:.95">
            <strong>實際錯誤訊息：</strong><br>
            ${escapeHtml(err?.message || String(err))}
          </div>
          <div style="opacity:.8;margin-top:10px">
            請確認：<br>
            1) Sheet：任何知道連結的人 → 檢視者<br>
            2) 分頁名稱：總表（完全一致）<br>
            3) 直開 Debug 連結能看到 table/rows（不需登入）
          </div>
        </div>`;
      }
    });
  </script>
</body>
</html>