<!doctype html>
<html lang="zh-TW" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>員工桌號查詢 Employee Table Lookup</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap">

  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      font-family: 'Noto Sans TC', system-ui, -apple-system, sans-serif;
    }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #eid::placeholder { color: #6b7280; }
  </style>
</head>

<body class="h-full">
  <div id="app" class="w-full h-full"></div>

  <script>
    // ============================================================
    // ✅ Google Sheet（Publish to web → CSV）
    // ============================================================
    const PUBLISHED_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRHlG9WMRmD7yKNT3sOFSxmI4QWPI-kz8pGXKRoNxuVDMajS9RT4JWCT-s0sbcPDoBECq4tTGbVeNcd/pub?gid=1865948020&single=true&output=csv";

    // ============================================================
    // UI 設定
    // ============================================================
    const config = {
      bg: '#0f172a',
      card: '#1e293b',
      text: '#f1f5f9',
      primary: '#3b82f6',
      secondary: '#64748b',
      font: 14,
      title: '員工桌號查詢' <br> 'Employee Table Lookup'
    };

    let data = [];
    let loading = true;
    let reloading = false;
    let autoClearTimer = null;

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }

    function csvUrl() {
      return PUBLISHED_CSV_URL + (PUBLISHED_CSV_URL.includes('?') ? '&' : '?') + `_=${Date.now()}`;
    }

    // 簡易 CSV parser（支援引號與逗號）
    function parseCsvLine(line) {
      const out = [];
      let cur = '', inQ = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQ && line[i+1] === '"') { cur += '"'; i++; }
          else inQ = !inQ;
        } else if (ch === ',' && !inQ) {
          out.push(cur); cur = '';
        } else {
          cur += ch;
        }
      }
      out.push(cur);
      return out.map(s => s.trim());
    }

    function findHeaderIndex(headers, candidates) {
      const lower = headers.map(h => String(h || '').trim().toLowerCase());
      for (const cand of candidates) {
        const idx = lower.indexOf(String(cand).toLowerCase());
        if (idx >= 0) return idx;
      }
      return -1;
    }

    async function fetchData() {
      const res = await fetch(csvUrl(), { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const csv = await res.text();
      const lines = csv.split(/\r?\n/).filter(l => l.trim());

      if (lines.length < 2) return [];

      const headers = parseCsvLine(lines[0]);

      // 支援欄名：employee_id / table_number 或 員工編號 / 桌號
      const idxEmp = findHeaderIndex(headers, ['employee_id','employee id','員工編號','员工编号']);
      const idxTable = findHeaderIndex(headers, ['table','table_number','table number','桌號','桌号']);

      // 若找不到欄名：預設 A/B 欄
      const empCol = idxEmp >= 0 ? idxEmp : 0;
      const tableCol = idxTable >= 0 ? idxTable : 1;

      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = parseCsvLine(lines[i]);
        const employee_id = String(cols[empCol] ?? '').trim();
        const table_number = String(cols[tableCol] ?? '').trim();
        if (employee_id && table_number) rows.push({ employee_id, table_number });
      }

      // 去重 + 限制 999
      const seen = new Set();
      const dedup = [];
      for (const r of rows) {
        if (seen.has(r.employee_id)) continue;
        seen.add(r.employee_id);
        dedup.push(r);
        if (dedup.length >= 999) break;
      }

      return dedup;
    }

    async function loadInitial() {
      data = await fetchData();
      loading = false;
      render();
    }

    async function reloadData() {
      if (loading || reloading) return;
      reloading = true;
      render();
      try {
        data = await fetchData();
      } finally {
        reloading = false;
        render();
      }
    }

    function render() {
      const app = document.getElementById('app');
      const f = config.font;

      app.innerHTML = `
        <div class="min-h-full flex items-center justify-center p-6" style="background:${config.bg};color:${config.text}">
          <div class="w-full max-w-md">
            <div class="text-center mb-6">
              <h1 style="font-size:${f*2}px;font-weight:700">${escapeHtml(config.title)}</h1>
            </div>

            <div class="p-6 rounded-lg" style="background:${config.card}">
              <button id="reloadBtn"
                style="width:100%;margin-bottom:${f}px;background:${config.secondary};color:#fff;padding:${f*.85}px;border-radius:8px;border:none;cursor:pointer">
                ${reloading ? '載入中… Loading…' : '重新載入資料 Reload Data'}
              </button>

              <div style="display:flex; justify-content:space-between; font-size:${f*.85}px; opacity:.85; margin-bottom:${f}px;">
                <div>目前資料筆數：${data.length}</div>
                <div>${loading ? '資料載入中…' : ''}</div>
              </div>

              <input
                id="eid"
                type="text"
                inputmode="numeric"
                placeholder="請輸入員工編號 / Enter Employee ID"
                style="
                  width:100%;
                  padding:${f}px;
                  border-radius:8px;
                  border:none;
                  margin-bottom:${f}px;
                  font-size:${f*1.1}px;
                  color:#000;
                  background:#fff;
                ">

              <div style="display:flex;gap:${f}px">
                <button id="searchBtn"
                  style="flex:1;background:${config.primary};color:#fff;padding:${f}px;border-radius:8px;border:none;cursor:pointer">
                  查詢 Search
                </button>
                <button id="resetBtn"
                  style="flex:1;background:${config.secondary};color:#fff;padding:${f}px;border-radius:8px;border:none;cursor:pointer">
                  重設 Reset
                </button>
              </div>

              <div id="result" style="margin-top:${f}px"></div>
            </div>

            <div class="text-center mt-6" style="font-size:${f*.8}px;opacity:.7">
              本工具僅作活動一次性使用，未連結公司內部系統，請放心使用<br>
              <em>This tool is for one-time event use only and is not connected to any internal company systems.</em>
            </div>
          </div>
        </div>
      `;

      const input = document.getElementById('eid');
      const result = document.getElementById('result');

      // 只允許數字（最多 7 位）
      input.addEventListener('input', (e) => {
        let v = e.target.value.replace(/[^0-9]/g, '');
        if (v.length > 7) v = v.slice(0, 7);
        e.target.value = v;
      });

      // Enter 直接查詢
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') query();
      });

      document.getElementById('reloadBtn').onclick = reloadData;
      document.getElementById('searchBtn').onclick = query;
      document.getElementById('resetBtn').onclick = () => {
        input.value = '';
        result.innerHTML = '';
        input.focus();
      };
    }

    function query() {
      const input = document.getElementById('eid');
      const result = document.getElementById('result');
      const id = (input?.value || '').trim();
      if (!id) return;

      clearTimeout(autoClearTimer);

      const found = data.find(x => String(x.employee_id) === id);

      if (found) {
        result.innerHTML = `
          <div class="fade-in" style="padding:12px;border-left:4px solid ${config.primary};background:rgba(255,255,255,0.06);">
            <div style="opacity:.9;margin-bottom:4px;">桌號 Table</div>
            <div style="font-size:${config.font*1.6}px;font-weight:800;">
              ${escapeHtml(found.table_number)}
            </div>
          </div>
        `;
      } else {
        result.innerHTML = `
          <div class="fade-in" style="padding:12px;border-left:4px solid #ef4444;background:rgba(255,255,255,0.06);">
            查無此員工 / Not Found
          </div>
        `;
      }

      autoClearTimer = setTimeout(() => { result.innerHTML = ''; }, 3000);
    }

    // init
    render();
    loadInitial().catch(() => {
      loading = false;
      render();
      const result = document.getElementById('result');
      if (result) {
        result.innerHTML = `
          <div class="fade-in" style="padding:12px;border-left:4px solid #ef4444;background:rgba(255,255,255,0.06);">
            讀取資料失敗 / Failed to load data<br>
            請稍後再試 / Please try again later
          </div>
        `;
      }
    });
  </script>
</body>
</html>